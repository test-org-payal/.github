name: Add PR Workflow to All Repos

on:
  workflow_dispatch:

jobs:
  add-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Add workflow to all repos
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.TOKEN }}
          script: |
            const org = 'test-org-payal';
            const projectNumber = 2;
            
            // Workflow content to add to each repo
            const workflowContent = `name: Add PR to Project

            on:
              pull_request:
                types: [opened, edited, reopened]
                branches:
                  - main
                  - master

            jobs:
              add-to-project:
                runs-on: ubuntu-latest
                steps:
                  - name: Add PR to Project
                    uses: actions/github-script@v7
                    with:
                      github-token: \${{ secrets.PROJECT_TOKEN }}
                      script: |
                        const pr = context.payload.pull_request;
                        
                        const projectData = await github.graphql(\`
                          query($org: String!, $number: Int!) {
                            organization(login: $org) {
                              projectV2(number: $number) {
                                id
                              }
                            }
                          }
                        \`, {
                          org: '${org}',
                          number: ${projectNumber}
                        });
                        
                        const projectId = projectData.organization.projectV2.id;
                        
                        try {
                          await github.graphql(\`
                            mutation($projectId: ID!, $contentId: ID!) {
                              addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                                item { id }
                              }
                            }
                          \`, {
                            projectId: projectId,
                            contentId: pr.node_id
                          });
                          console.log('‚úÖ PR added to project');
                        } catch (e) {
                          if (e.message.includes('already exists')) {
                            console.log('‚ÑπÔ∏è PR already in project');
                          } else {
                            console.error('‚ùå Error:', e.message);
                          }
                        }
            `;

            // Get all repos in org
            const repos = await github.paginate(github.rest.repos.listForOrg, {
              org: org,
              per_page: 100
            });
            
            console.log(`Found ${repos.length} repositories in ${org}`);
            console.log('---');
            
            let successCount = 0;
            let failCount = 0;
            
            for (const repo of repos) {
              console.log(`\nProcessing: ${repo.name}`);
              
              const path = '.github/workflows/pr-to-project.yml';
              
              // Check if file exists
              let sha = null;
              try {
                const existing = await github.rest.repos.getContent({
                  owner: org,
                  repo: repo.name,
                  path: path,
                  ref: repo.default_branch
                });
                sha = existing.data.sha;
                console.log(`  ‚ÑπÔ∏è Workflow exists, updating...`);
              } catch (e) {
                if (e.status === 404) {
                  console.log(`  ‚ÑπÔ∏è Workflow not found, creating...`);
                } else {
                  console.log(`  ‚ö†Ô∏è Error checking file: ${e.message}`);
                }
              }
              
              // Create or update file
              try {
                const params = {
                  owner: org,
                  repo: repo.name,
                  path: path,
                  message: sha ? 'Update PR to Project workflow' : 'Add PR to Project workflow',
                  content: Buffer.from(workflowContent).toString('base64'),
                  branch: repo.default_branch
                };
                
                if (sha) {
                  params.sha = sha;
                }
                
                await github.rest.repos.createOrUpdateFileContents(params);
                console.log(`  ‚úÖ Success`);
                successCount++;
              } catch (e) {
                console.log(`  ‚ùå Failed: ${e.message}`);
                failCount++;
              }
            }
            
            console.log('\n---');
            console.log(`\nüìä Summary:`);
            console.log(`   Total repos: ${repos.length}`);
            console.log(`   ‚úÖ Success: ${successCount}`);
            console.log(`   ‚ùå Failed: ${failCount}`);
            console.log('\n‚úÖ Done!');
