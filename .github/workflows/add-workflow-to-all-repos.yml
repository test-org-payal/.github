name: Add PR Workflow to All Repos

on:
  workflow_dispatch:

jobs:
  add-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Add workflow to all repos
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.TOKEN }}
          script: |
            const org = 'test-org-payal';
            const skipRepos = ['.github'];
            
            // Exact workflow content with workflow_dispatch
            const workflowContent = `name: Add PR to Project

            on:
              workflow_dispatch:
              pull_request:
                types: [opened, edited, reopened]
                branches:
                  - main
                  - master

            jobs:
              add-to-project:
                runs-on: ubuntu-latest
                steps:
                  - name: Add PR to Project
                    uses: actions/github-script@v7
                    with:
                      github-token: $` + `{{ secrets.TOKEN }}
                      script: |
                        const pr = context.payload.pull_request;
                        
                        const projectData = await github.graphql(\`` + `
                          query($` + `org: String!, $` + `number: Int!) {
                            organization(login: $` + `org) {
                              projectV2(number: $` + `number) {
                                id
                              }
                            }
                          }
                        \`` + `, {
                          org: 'test-org-payal',
                          number: 2
                        });
                        
                        const projectId = projectData.organization.projectV2.id;
                        
                        try {
                          await github.graphql(\`` + `
                            mutation($` + `projectId: ID!, $` + `contentId: ID!) {
                              addProjectV2ItemById(input: {projectId: $` + `projectId, contentId: $` + `contentId}) {
                                item { id }
                              }
                            }
                          \`` + `, {
                            projectId: projectId,
                            contentId: pr.node_id
                          });
                          console.log('‚úÖ PR added to project');
                        } catch (e) {
                          if (e.message.includes('already exists')) {
                            console.log('‚ÑπÔ∏è PR already in project');
                          } else {
                            console.error('‚ùå Error:', e.message);
                          }
                        }
            `;

            // Get all repos
            const repos = await github.paginate(github.rest.repos.listForOrg, {
              org: org,
              per_page: 100
            });
            
            console.log(`Found ${repos.length} repositories in ${org}`);
            console.log('---\n');
            
            let successCount = 0;
            let failCount = 0;
            let skippedCount = 0;
            
            for (const repo of repos) {
              if (skipRepos.includes(repo.name)) {
                console.log(`‚è≠Ô∏è  Skipping: ${repo.name}`);
                skippedCount++;
                continue;
              }
              
              console.log(`Processing: ${repo.name}`);
              
              const path = '.github/workflows/pr-to-project.yml';
              
              let sha = null;
              try {
                const existing = await github.rest.repos.getContent({
                  owner: org,
                  repo: repo.name,
                  path: path,
                  ref: repo.default_branch
                });
                sha = existing.data.sha;
                console.log(`  Updating existing workflow...`);
              } catch (e) {
                if (e.status === 404) {
                  console.log(`  Creating new workflow...`);
                } else {
                  console.log(`  Warning: ${e.message}`);
                }
              }
              
              try {
                const params = {
                  owner: org,
                  repo: repo.name,
                  path: path,
                  message: sha ? 'Update: PR to Project workflow [skip ci]' : 'Add: PR to Project workflow [skip ci]',
                  content: Buffer.from(workflowContent).toString('base64'),
                  branch: repo.default_branch
                };
                
                if (sha) {
                  params.sha = sha;
                }
                
                await github.rest.repos.createOrUpdateFileContents(params);
                console.log(`  ‚úÖ Success\n`);
                successCount++;
              } catch (e) {
                console.log(`  ‚ùå Failed: ${e.message}\n`);
                failCount++;
              }
            }
            
            console.log('---');
            console.log('\nüìä Summary:');
            console.log(`   Total repos: ${repos.length}`);
            console.log(`   ‚è≠Ô∏è  Skipped: ${skippedCount}`);
            console.log(`   ‚úÖ Success: ${successCount}`);
            console.log(`   ‚ùå Failed: ${failCount}`);
            console.log('\n‚úÖ Done!');
